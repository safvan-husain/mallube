import "dotenv/config";
import express from "express";
import cors from "cors";
import fileUpload from "express-fileupload";
import {initializeApp} from "firebase-admin/app";
import {credential} from "firebase-admin";

import connectDb from "./config/db";
import bcrypt from "bcryptjs";
import adminRoutes from "./routes/adminRoutes";
import userRoutes from "./routes/userRoutes";
import staffRoutes from "./routes/staffRoutes";
import productRoutes from "./routes/productRoutes";
import categoryRoutes from "./routes/categoryRoutes";
import StoreRoutes from "./routes/storeRoutes";
import advertisementRoutes from "./routes/advertisementRoutes";
import utilsRoutes from "./routes/utilsRoutes";
import subscriptionRoutes from "./routes/subscriptionRoutes"
import bookingRoutes from './routes/bookingRoutes'
import {notificationRouter} from "./routes/notificationRoute";
import './utils/common'
import {errorHandler, notFound} from "./middleware/error.middleware";
import {config} from "./config/vars";
import {periodicallyChangeStatusOfExpiredAdvertisemets} from "./controllers/advertisement/advertisementController";
import expressAsyncHandler from "express-async-handler";
import Store from "./models/storeModel";
import Product from "./models/productModel";
import {searchRouter} from "./routes/searchRoutes";
import {individualBussinessRoutes} from "./routes/individualBussinessRoutes";
import {buyAndSellRouter} from "./routes/buy_and_sell_route";
import {Server} from 'socket.io';
import {socketHandler} from "./controllers/web-socket/webSocketController";
import {chatRoutes} from "./routes/messageRoutes";
import {removeExpiredAds} from "./controllers/user/buy_and_sell/buy_and_sellController";
import Temp from "./models/Path";
import {paginationSchema} from "./types/validation";
import {onCatchError} from "./controllers/service/serviceContoller";
import {z} from "zod";

const serviceAccount = require('./secrets/serviceAccountKey.json');

require("dotenv").config();


const app = express();

let errorMessage = "nothing";


connectDb();
initializeApp({credential: credential.cert(serviceAccount)});

app.use(express.json({limit: "50mb"}));
app.use(express.urlencoded({extended: true}));
app.use(cors());

app.use(
    fileUpload({
        limits: {fileSize: 10 * 1024 * 1024},
        // createParentPath: true,
        abortOnLimit: true,
        responseOnLimit: 'max _ mb only',
        // useTempFiles: true, /// By default this module uploads files into RAM. Setting this option to True turns on using temporary files instead of utilising RAM. This avoids memory overflow issues when uploading large files or in case of uploading lots of files at same time.
    })
);

app.post("/api/temp", async (req, res) => {
    const {paths} = req.body;
    if (Array.isArray(paths)) {
        try {
            await Temp.push(paths);
            res.status(200).json({message: "success"});
        } catch (e) {
            console.log("error", e);
            res.status(500).json({message: "error", e});
        }
    } else {
        res.status(401).json({message: "what the f**k, pass lat, long"});
    }
});

app.get("/api/temp", async (req, res) => {
    try {
        res.status(200).json(await Temp.find());
    } catch (e) {
        console.log("error", e);
        res.status(500).json({message: "error", e});
    }
});

app.use("/api/healthcheck", (req, res) => {
    res.status(200).send(`Server is healthy but ${errorMessage}`);
});



let k = ["1721033148177_977_images.webp", "1721035511045_400_images.webp", "1721036459229_679_IMG_20240715_151021_HDR (1).webp",
    "1721036459229_679_IMG_20240715_151021_HDR.webp", "1721043630712_824_IMG_1840.webp",
    "1721383071110_211_df1f0de6-617d-47db-afc5-96467b051dcb.webp", "1721385882461_576_images.webp",
    "1721390226350_993_FA1A82CE-45DC-4115-BDA8-29B9EED09714.webp", "1721390997485_795_images.webp",
    "1721454919474_286_IMG_2485.webp", "1721457917661_499_images.webp", "1721466211267_996_17214660232233953633545877221941.webp",
    "1721472029801_803_17214719807586326751954755416274.webp", "1721476572462_871_17214764924288873694119280479217.webp",
    "1721480486583_608_IMG_1952.webp", "1721532612819_195_IMG_20240614_143114_779.webp", "1721641138367_91_IMG-20240212-WA0006.webp",
    "1721717410895_873_IMG_2013.webp", "1721721485785_576_IMG_2014.webp", "1721723627799_285_6c887385-92a9-4f68-9757-41d3a4699562.webp",
    "1721725285160_660_IMG_2020.webp", "1721728760634_673_IMG_2023.webp", "1722497111353_264_images.webp",
    "1722500840022_788_IMG_20240729_133215061.webp", "1722504479296_663_IMG_20231202_091312.webp",
    "1722512716294_916_IMG_20240701_092130_268.webp", "1722516484790_28_IMG_20240801_180407.webp", "1722577154914_957_IMG_5473.webp",
    "1722582310699_163_IMG_0021.webp", "1722588915231_345_17225888464881776444688007229680.webp", "1722592167206_47_1648022442555(1).webp",
    "1722592849066_956_17225927649811952737606311541671.webp", "1722594744388_222_17225945790117782845686015491807.webp",
    "1722597753555_133_17225976719252792947569938724988.webp", "1722600719403_814_images.webp", "1722662873124_846_images.webp",
    "1722664445257_412_1000136441.webp", "1722670263055_484_17226701727588974729512082798835.webp",
    "1722670348179_890_17226701881926672926190236165661.webp", "1722673646432_752_1722673573990826395745167055297.webp",
    "1722677647577_926_17226775695497006484732922421542.webp", "1722689202264_835_17226890795303818357989877536253.webp",
    "1722832567282_643_17228324982657260863572155473643.webp", "1722834273878_193_17228341600677166991239664790150.webp",
    "1722836379550_202_17228362935445176428561800848984.webp", "1722837352678_288_17228373048727211744499848017750.webp",
    "1722840176320_719_1722840116755818902071386068584.webp", "1722841766384_947_17228415100536360900732318774617.webp",
    "1722844734054_634_17228445585516847649699814142669.webp", "1722850284524_416_17228502424532773377356437996414.webp",
    "1722851989872_136_17228518639387755828339153093679.webp", "1722923774543_737_17229237252839161793301161957385.webp",
    "1722925618657_202_scratch-card1.webp", "1722926084583_394_17229260138577754323518091097608.webp",
    "1722926175221_709_17229260387964639079062051477839.webp",
    "1722928102092_957_IMG_20240806_103723.webp", "1722931394028_970_IMG_8936.webp", "1722936998766_463_17229369402785304538598864646674.webp",
    "1722940937687_765_17229401026297985994706191618293.webp",
    "1722945011918_32_17229449265167472125219924693936.webp", "1723006428471_219_17230063574004787930932752265625.webp",
    "1723007450448_379_17230073535336863774092312366853.webp", "1723009276670_156_IMG_4713.webp",
    "1723010236482_709_17230101734344321242239834681820.webp",
    "1723013175687_341_17230131085414751639904247757239.webp", "1723013786063_329_17230137026241377624923137530355.webp",
    "1723017772805_255_1000698307.webp", "1723021949227_232_17230218789864417681137340296250.webp",
    "1723025056761_227_17230249962528080991315895101418.webp",
    "1723027960449_395_172302780046856774647858189091.webp", "1723031346700_146_17230312992815351022698936872320.webp",
    "1723035027251_254_17230347849725963202032372645545.webp",
    "1723041428788_186_17230413520771695361703977942968.webp",
    "1723092539372_329_17230924698915805642761458350625.webp", "1723093131146_81_17230930776091251422071562833407.webp", "1723095173069_170_17230950559016567422347231026184.webp",
    "1723097361391_112_1723097270512669555565984991467.webp", "1723101098834_249_17231010321954620524067224852447.webp", "1723103050876_361_17231029020038874969059652721425.webp",
    "1723104013222_598_17231039604762727064395075376618.webp", "1723105754184_919_17231056676872865888674764263318.webp", "1723109783777_176_17231096516013682099962676273477.webp",
    "1723113521604_926_20240508_114644_0000.webp", "1723116018565_384_17231159592276315740724558583252.webp", "1723117276646_896_17231172173882127410080351185991.webp",
    "1723118519958_518_226810825_210620124403601_1697899346870074360_n.webp", "1723120666579_977_1723120388661280855899944552431.webp", "1723122111186_958_IMG-20240808-WA0192.webp",
    "1723196187619_497_1000017194.webp", "1723197869838_371_17231977847752993181854180939317.webp", "1723209692732_54_IMG-20240809-WA0003.webp", "1723265759020_161_17232656236628128196401214524977.webp",
    "1723268492538_253_17232684032361368670936039242252.webp", "1723271908474_926_17232718225826467573272645590536.webp", "1723273350424_52_17232731256986342594737969981977.webp",
    "1723275835254_472_IMG-20240810-WA0006.webp", "1723278127457_454_17232778249876420411549500687849.webp", "1723279758583_772_IMG_20240810_141704.webp", "1723289296467_660_17232891790583206700746188129641.webp", "1723444178227_284_17234441207216191729190396394688.webp", "1723445171830_72_IMG-20240812-WA0001.webp", "1723446739749_998_17234465210864897182481424437572.webp", "1723449575014_969_1723449512408622473565262539530.webp", "1723453245172_336_17234527799971839406108220553995.webp", "1723455520894_883_17234554385638479713339735947344 (1).webp", "1723455520894_883_17234554385638479713339735947344.webp", "1723459239810_713_17234591189711833034984090155324.webp", "1723460870626_497_17234608216405707526646182274283.webp", "1723461959082_896_17234619020198063409755611895401.webp", "1723531932458_485_17235318468034527532002938969228.webp", "1723538449688_792_17235384114572361561612686028901.webp", "1723544967918_117_1000061215.webp", "1723544991232_903_17235449027591249412039278342480.webp", "1723548414692_919_17235483435941443264523183476101.webp", "1723567553906_37_InShot_20240813_221423786.webp", "1723611266963_616_17236110910701893835263833141890.webp", "1723612298892_244_17236122427119003160227706059898.webp", "1723614655387_130_17236145771213008341643920914942.webp", "1723616743929_437_17236165918983664106700541241929.webp", "1723618322300_310_17236181446582952944226675549589.webp", "1723619597196_795_17236194639325554265504678302422.webp", "1723621259702_98_20240814_130116.webp", "1723625485794_273_17236253550828536762712547867976.webp", "1723628489410_857_17236284528636663685364366231147.webp", "1723631614159_907_17236313067298717595801491251959.webp", "1723633846464_521_17236337556902775107465024101368.webp", "1723701699213_468_17237016535193192949249269003014.webp", "1723705554228_561_17237054200715878549504451228713.webp", "1723707272546_302_17237072153381826810449376748964.webp", "1723712842682_866_17237127760336150480824404580347.webp", "1723714601404_816_17237145083748267695386175520654.webp", "1723717193204_2_17237170832267882814033453848053.webp", "1723721418658_945_17237213003871640455485908415821.webp", "1723743546682_388_IMG-20240815-WA0074.webp", "1723790643721_747_1723790578519391039008352710997.webp", "1723800378314_367_17238002768272337831140803358294.webp", "1723803271332_932_1000156324.webp", "1723805216534_189_17238050918287474899461641546879.webp", "1723874168891_394_IMG-20240817-WA0003.webp", "1723878833993_329_17238787846958617720701527476713.webp", "1723881339056_598_17238812290996707974725327619221.webp", "1724041791493_494_17240416928907693981499948148025.webp", "1724047034491_281_17240469598947868145682507297002.webp", "1724060543126_152_IMG_6845.webp", "1724065116075_565_17240649991701677436546082555583.webp", "1724071380334_953_IMG-20240819-WA0029.webp", "1724131998624_402_IMG_20240819_114653.webp", "1724220179781_494_IMG_20240821_112654.webp", "1724222223679_345_17242221408383415829451629089667.webp", "1724317323571_299_17243172055547477208473943319811.webp", "1724323507815_702_IMG-20240822-WA0002.webp", "1724326904447_527_IMG_20240822_170930.webp", "1724329359986_446_17243292847341794641399031240964.webp", "1725695992799_582_image.webp", "1726203483190_177_IMG_9585.webp", "1726208717848_670_20240806_202908.webp", "1726210575685_157_17262104908784420339027160937859.webp", "1726213448582_411_17262134222276842331797474898931.webp", "1726296530961_248_17262964538201624387260682612139.webp", "1726299786634_272_17262997479512523072053971456531.webp", "1726301543441_246_1000029095.webp", "1726306580565_462_1726306542567428949357225357638.webp", "1726308405201_230_17263082651743577552340078224414.webp", "1726309662892_717_1726309566646696236435038296684.webp", "1726463999173_632_1726463921774131481767182865707.webp", "1726473261282_666_17264731301121228270755863490776.webp", "1726473757542_359_17264736738616158431820929193790.webp", "1726497554569_913_1000021500.webp", "1726537318125_727_Untitled_design.webp", "1726566878542_156_17265668318355215671361969993611.webp", "1726581942526_839_17265817747624465304803146080282.webp", "1726639669852_446_IMG_20240918_113322.webp", "1726669650576_606_17266695930244639092609209158574.webp", "1726812245764_517_17268120723065090962507623694051.webp", "1726826869726_423_IMG-20240907-WA0050.webp", "1726834165638_501_1726834006035572833208846149525.webp", "1726839568736_636_17268394077904299516124702064005.webp", "1726842885116_855_17268426337798799141487821025273.webp", "1726897605690_538_IMG_20240921_111307.webp", "1726903439470_985_IMG_20240406_205933.webp", "1726909464533_745_17269093092606418828037304748946.webp", "1726911235833_730_17269111253762675798599772637886.webp", "1727073963819_871_17270738482834138881323226885279.webp", "1727157488362_884_IMG_20240924_111808.webp", "1727169819066_65_IMG_20240924_145134.webp", "1727241610894_643_IMG_20240925_104105.webp", "1727244600338_692_IMG_20240925_113741~2.webp", "1727247783576_290_IMG_20240925_123156.webp", "1727354154077_837_17273540807314020803463638816802.webp", "1727415897726_397_IMG_20240927_111334.webp", "1727419504070_663_IMG_20240927_121108.webp", "1727423847570_890_17274237776333973643171941900288.webp", "1727434486731_849_1727434384759259225208078043453.webp", "1727439339090_618_17274392697981177767887675658558.webp", "1727503835763_953_17275037675568479576992107699708.webp", "1727518708210_153_17275184987183552780155883166107.webp", "1727522035468_66_17275219502778437557759578926409.webp", "1727526509667_920_17275264328084651844342411572201.webp", "1727673183911_798_17276729635195180006188074944034.webp", "1727679960159_6_17276798434975874958708228764916.webp", "1727681039680_322_image.webp", "1727682776142_88_17276827262895456567024859127027.webp", "1727694180609_740_17276938420482692275901622835140.webp", "1727700602386_891_17277005223685099153671572515244.webp", "1727767836958_793_IMG_20241001_125021~2.webp", "1727786696938_767_IMG_20241001_180824.webp", "1727793531998_88_IMG_20241001_122653.webp", "1727851118686_27_17278510317809015012305603843460.webp", "1727853824853_717_17278536893331052199226479750106.webp", "1727858277522_78_17278580696465094933553738586160.webp", "1727870590558_947_17278704861953555740908717085650.webp", "1727940496470_785_IMG_0575.webp", "1728029324085_221_17280284763152462215351081267745.webp", "1728036405257_775_17280363075365082612026980668817.webp", "1728038584088_613_17280385009446387143758748692274.webp", "1728041224606_659_17280410040908208548543086951201.webp", "1728041418527_568_17280413003241908614166603794004.webp", "1728046057105_644_1728045955359579586788487180433.webp", "1728125551434_335_IMG_20241005_161531.webp", "1728128630118_244_17281284805195334128079297374052.webp", "1728130526377_450_17281304742883148853426047982626.webp", "1728373083253_169_17283729279231278863245864687623.webp", "1728375095983_473_IMG_20241008_133432~2.webp", "1728376822193_904_17283767116786412317263056918509.webp", "1728390688350_332_17283905772547283656096709229180.webp", "1728454781025_300_17284546418125082388711335711607.webp", "1728550331572_441_17285500889605347245911402886743.webp", "1728560899585_637_17285589989676767538688506947821.webp", "1728647696439_222_17286472251997238497357997348227.webp", "1728651000834_269_17286509063846882253743388108925.webp", "1728722277254_852_17287221413014349257310617912734.webp", "1728888522190_480_17288884540995885215636417340698.webp", "1728890171938_315_17288900721153381320412649853467.webp", "1728999443836_43_IMG_6187.webp", "1729000715906_417_17290006161964569153993804919675.webp", "1729055236582_541_1000049080.webp", "1729149379965_18_image.webp", "1729150678680_845_17291505871782531467110038022898.webp", "1729322109106_715_17293219398678902242622458476505.webp", "1729497525734_738_17294974566281521344247379518859.webp", "1729500005372_235_17294998927144664501065178983649.webp", "1729501353921_739_17295012753871342434468328617825.webp", "1729593266838_613_17295931956427232740112656498634.webp", "1729596382718_484_1000015766.webp", "1729769976230_625_17297698223978315133925559473699.webp", "1729837555470_751_17298374760217763672332747008380.webp", "1729839287530_555_1729839192346744446465565021605.webp", "1729841034246_996_17298406056327693419988195041178 .webp", "1729841034246_996_17298406056327693419988195041178.webp", "1729847456202_384_17298470488026687488639385614274.webp", "1729924495808_694_17299244569437471497895585947291.webp", "1729929119074_500_17299290586482237053286123117311.webp", "1730097975242_185_17300979356251707817177545766626.webp", "1730099057194_54_17300990039246516185028896298598.webp", "1730112440675_770_IMG-20241028-WA0001.webp", "1730273773201_404_17302737140675021089081794667154.webp", "1730276245963_201_17302761498131581543713045475269.webp",
    "1730276832555_95_17302767614887550976987844952393.webp", "1730291331006_704_IMG-20241030-WA0000.webp", "1730370933332_939_1730370857870166449385114798043.webp",
    "1730441048271_133_1730440988545251087935071111104.webp", "1730441924922_189_17304418225721361523455296879010.webp", "1730528893541_319_17305288452808647921023466328696.webp",
    "1730530231314_372_1730530178990131384566617081317.webp", "1730798118938_993_1730798048192329356834959540976.webp", "1730808268213_817_IMG-20241105-WA0001.webp",
    "1730881879098_712_17308817893543375670849599659106.webp", "1730888838782_653_IMG-20241106-WA0001.webp", "1731152839763_389_IMG-20241109-WA0000.webp", "1737541293794_928_74a037f3-a3b1-4253-81e6-ba40b430bf113812981757201376421.jpeg", "1737544380189_182_6cddac1a-e386-443c-9043-74cc0ebb1f2a1433262342518024756.jpeg", "1737544872436_272_1c92755e-5861-409a-9d67-721fe402fe8a8503685781863758886.jpeg", "1737545131987_871_1000079757.webp", "1737545467492_829_b978e4b6-4c6c-478f-bd6a-80e7e26a78e16829538626276051452.jpeg", "1737545868334_722_ef38ed4f-42fe-4c55-be5c-89bc0206a42d1361031593622907363.jpeg", "1737547444562_818_1000079471.webp", "1737631604222_434_1000079968.webp", "1737733078416_902_1000041454.webp", "1737734590708_142_1000041454.webp", "1737734993137_280_1000041454.webp", "1737790245265_382_1000080319.webp", "1737791719096_92_1000001352.webp", "1738047225342_516_1000079757.webp", "1738084898126_508_1000080742.webp", "1738085179538_749_1000080742.webp", "1738134206910_516_1000080742.webp", "1738135015451_70_1000080308.webp", "1738135688762_176_1000080742.webp", "1738500631362_706_1000081155.webp", "1738572677851_648_1000081606.jpeg", "1738579050175_885_1000080901.webp", "1738669544414_310_1000081020.webp", "1739431488624_979_20250213_124343.jpeg", "1739432586444_835_20250213_124343.jpeg"]


const updateData = expressAsyncHandler(
    async (req, res) => {
        let data = paginationSchema.parse(req.body);
        try {
            let s = await Store.find({}, { storeName: true, shopImgUrl: true }).skip(data.skip).limit(data.limit);
            for (const n of s) {
                for (const p of k) {
                    let j = p.split(".")[0];
                    if (n.shopImgUrl.includes(j)) {
                        n.image = n.shopImgUrl;
                        n.shopImgUrl = `https://static.vendroo.in/${p}`;
                        await n.save();
                        break;
                    }
                }
            }
            let z = await Store.find({ }, { storeName: true, shopImgUrl: true, image: true}).skip(data.skip).limit(data.limit).lean();
            // let s = await Store.find({ authToken: {$exists: false}})
            res.status(200).json({ s, z});
        } catch (error) {
            res.status(400).json({message: error})
        }
    }
)
app.get('/api/test', async (req, res) => {
    try {
        let data = z.object({
            search: z.string().optional(),
            image: z.string().optional()
        }).merge(paginationSchema).parse(req.query);

        // let admin = await AdminModel.findOne({ email: "m.safvan@gmail.com"});
        // if(!admin) {
        //     res.status(200);
        //     return;
        // }
        // admin.token = admin.generateAuthToken(admin._id);
        // await admin.save();
        let query: any = {};
        if(data.search) {
            query.storeName = {$regex: data.search, $options: 'i'};
        }
        if(data.image) {
            query.shopImgUrl = { $regex: data.image, $options: 'i'};
        }
        // let stores: any[] = await Store.find({authToken: {$exists: false}});
        // let result = await Promise.all(stores.map(async (e) => {
        //     e.authToken = e.generateAuthToken();
        //     return await e.save();
        // }));
        // console.log(result);
        // let users = await User.find({ authToken: { $exists: false }});
        // let result2 = await Promise.all(users.map(async (e) => {
        //     e.authToken = e.generateAuthToken();
        //     return await e.save();
        // }));
        // res.status(200).json({ result, result2 });
        const stores = await Store.find(query, { shopImgUrl: true, storeName: true, uniqueName: true }).skip(data.skip).limit(data.limit).lean();
        const products = await Product.find({}, { images: true, name: true }).skip(data.skip).limit(data.limit).lean();
        res.status(200).json({ stores, products, length: stores.length + products.length });
    } catch (e) {
        onCatchError(e, res);
    }
});

app.use("/api/developer/transform", updateData);

app.use("/api/admin", adminRoutes);
app.use("/api/user", userRoutes);
app.use("/api/staff", staffRoutes);
app.use("/api/product", productRoutes);
app.use("/api/category", categoryRoutes);
app.use("/api/store", StoreRoutes);
app.use("/api/advertisement", advertisementRoutes);
app.use("/api/utils", utilsRoutes);
app.use("/api/subscription", subscriptionRoutes);
app.use("/api/booking", bookingRoutes);
app.use("/api/notification", notificationRouter)
app.use('/api/search', searchRouter);
app.use('/api/service', individualBussinessRoutes);
//buy-and-sell
app.use('/api/bas', buyAndSellRouter);
app.use('/api/chats', chatRoutes);

app.use(notFound);
app.use(errorHandler);

periodicallyChangeStatusOfExpiredAdvertisemets();

const PORT = config.port || 4000;

let server = app.listen(PORT, () => console.log(`API server listening at ${PORT}`));

const io = new Server(server);
try {
    socketHandler(io);
} catch (error: any) {
    console.log('socket error');
    errorMessage = error.toString();
    console.log(error);
}


//to delelte expired ads (buy and sell), and it related images.
setInterval(() => {
    try {
        removeExpiredAds();
    } catch (error) {
        console.error(error)
    }
}, 24 * 60 * 60 * 1000);

